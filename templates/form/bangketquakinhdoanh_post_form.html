{% extends 'main.html' %}

{% block content %}
<div class="container mt-4 mb-5">
    <h2>Nhập liệu Bảng Kết Quả Kinh Doanh</h2>
    <p>Form nhập liệu thủ công.</p>

    <form id="kqkdForm">
        
        <div class="mb-3">
            <label for="congTySelect" class="form-label"><strong>1. Chọn Công Ty</strong></label>
            <select id="congTySelect" class="form-select" required>
                <option value="" selected disabled>Đang tải danh sách công ty...</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="baoCaoSelect" class="form-label"><strong>2. Chọn Báo Cáo Tài Chính (Bắt buộc)</strong></label>
            <select id="baoCaoSelect" class="form-select" required disabled>
                <option value="" selected disabled>-- Vui lòng chọn công ty ở trên trước --</option>
            </select>
        </div>
        
        <hr>
        
        <h3 class="mt-4 text-primary">PHẦN KẾT QUẢ KINH DOANH</h3>

        <div class="row">
            <div class="col-md-4 mb-3"><label for="doanhThuBanHangVaCungCapDichVu" class="form-label">Doanh thu bán hàng & CCDV</label><input type="number" class="form-control" id="doanhThuBanHangVaCungCapDichVu"></div>
            <div class="col-md-4 mb-3"><label for="cacKhoanGiamTruDoanhThu" class="form-label">Các khoản giảm trừ doanh thu</label><input type="number" class="form-control" id="cacKhoanGiamTruDoanhThu"></div>
            <div class="col-md-4 mb-3"><label for="doanhThuThuan" class="form-label">Doanh thu thuần</label><input type="number" class="form-control" id="doanhThuThuan"></div>
            <div class="col-md-4 mb-3"><label for="giaVonHangBan" class="form-label">Giá vốn hàng bán</label><input type="number" class="form-control" id="giaVonHangBan"></div>
            <div class="col-md-4 mb-3"><label for="loiNhuanGop" class="form-label">Lợi nhuận gộp</label><input type="number" class="form-control" id="loiNhuanGop"></div>
            <div class="col-md-4 mb-3"><label for="doanhThuHoatDongTaiChinh" class="form-label">Doanh thu hoạt động tài chính</label><input type="number" class="form-control" id="doanhThuHoatDongTaiChinh"></div>
            <div class="col-md-4 mb-3"><label for="chiPhiTaiChinh" class="form-label">Chi phí tài chính</label><input type="number" class="form-control" id="chiPhiTaiChinh"></div>
            <div class="col-md-4 mb-3"><label for="trongDoChiPhiLaiVay" class="form-label">Trong đó: Chi phí lãi vay</label><input type="number" class="form-control" id="trongDoChiPhiLaiVay"></div>
            <div class="col-md-4 mb-3"><label for="phanLaiLoTrongCongTyLienDoanhLienKet" class="form-label">Phần lãi/lỗ trong cty liên kết</label><input type="number" class="form-control" id="phanLaiLoTrongCongTyLienDoanhLienKet"></div>
            <div class="col-md-4 mb-3"><label for="chiPhiBanHang" class="form-label">Chi phí bán hàng</label><input type="number" class="form-control" id="chiPhiBanHang"></div>
            <div class="col-md-4 mb-3"><label for="chiPhiQuanLyDoanhNghiep" class="form-label">Chi phí quản lý doanh nghiệp</label><input type="number" class="form-control" id="chiPhiQuanLyDoanhNghiep"></div>
            <div class="col-md-4 mb-3"><label for="loiNhuanThuanTuHoatDongKinhDoanh" class="form-label">Lợi nhuận thuần từ HĐKD</label><input type="number" class="form-control" id="loiNhuanThuanTuHoatDongKinhDoanh"></div>
            <div class="col-md-4 mb-3"><label for="thuNhapKhac" class="form-label">Thu nhập khác</label><input type="number" class="form-control" id="thuNhapKhac"></div>
            <div class="col-md-4 mb-3"><label for="chiPhiKhac" class="form-label">Chi phí khác</label><input type="number" class="form-control" id="chiPhiKhac"></div>
            <div class="col-md-4 mb-3"><label for="loiNhuanKhac" class="form-label">Lợi nhuận khác</label><input type="number" class="form-control" id="loiNhuanKhac"></div>
            <div class="col-md-4 mb-3"><label for="tongLoiNhuanKeToanTruocThue" class="form-label">Tổng LN kế toán trước thuế</label><input type="number" class="form-control" id="tongLoiNhuanKeToanTruocThue"></div>
            <div class="col-md-4 mb-3"><label for="chiPhiThueTNDNHienHanh" class="form-label">Chi phí thuế TNDN hiện hành</label><input type="number" class="form-control" id="chiPhiThueTNDNHienHanh"></div>
            <div class="col-md-4 mb-3"><label for="chiPhiThueTNDNHoanLai" class="form-label">Chi phí thuế TNDN hoãn lại</label><input type="number" class="form-control" id="chiPhiThueTNDNHoanLai"></div>
            <div class="col-md-4 mb-3"><label for="loiNhuanSauThueThuNhapDoanhNghiep" class="form-label fw-bold">Lợi nhuận sau thuế TNDN</label><input type="number" class="form-control" id="loiNhuanSauThueThuNhapDoanhNghiep"></div>
        </div>

        <hr class="my-4">
        
        <button type="submit" class="btn btn-primary btn-lg">Lưu Dữ Liệu</button>
    </form>
    
    <div id="result" class="mt-3"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Khai báo các biến DOM
        const congTySelect = document.getElementById('congTySelect');
        const baoCaoSelect = document.getElementById('baoCaoSelect');
        const kqkdForm = document.getElementById('kqkdForm');
        const resultDiv = document.getElementById('result');

        // Hàm lấy CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- 1. TẢI DANH SÁCH CÔNG TY (Chạy ngay khi vào trang) ---
        async function loadCompanies() {
            try {
                const response = await fetch('/api/get_congty_data/');
                if (!response.ok) throw new Error('Không thể tải danh sách công ty');
                
                const data = await response.json();

                congTySelect.innerHTML = '<option value="" selected disabled>-- Chọn một Công ty --</option>';
                
                data.forEach(cty => {
                    const option = document.createElement('option');
                    option.value = cty.maChungKhoan;
                    option.textContent = `${cty.maChungKhoan} - ${cty.tenCongTy}`;
                    congTySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Lỗi:', error);
                congTySelect.innerHTML = '<option value="" selected disabled>Lỗi tải dữ liệu</option>';
            }
        }
        
        loadCompanies();

        // --- 2. SỰ KIỆN KHI CHỌN CÔNG TY -> TẢI BÁO CÁO TƯƠNG ỨNG ---
        congTySelect.addEventListener('change', async function() {
            const companyId = this.value;
            console.log('Công ty được chọn ID:', companyId);
            // Reset dropdown báo cáo về trạng thái loading
            baoCaoSelect.innerHTML = '<option value="" selected disabled>Đang tải báo cáo...</option>';
            baoCaoSelect.disabled = true;

            try {
                // Gọi API lấy báo cáo theo ID công ty
                const response = await fetch(`/api/get_tonghoptaichinh_data/?company_id=${companyId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',            
                    },                   
                });
                if (!response.ok) throw new Error('Không thể tải báo cáo');
                
                const reports = await response.json();
                console.log('Báo cáo nhận được:', reports.length);
                if (reports.length === 0) {
                    baoCaoSelect.innerHTML = '<option value="" selected disabled>Công ty này chưa có báo cáo nào</option>';
                } else {
                    baoCaoSelect.innerHTML = '<option value="" selected disabled>-- Chọn Năm/Quý --</option>';
                    
                    reports.forEach(report => {
                        const option = document.createElement('option');
                        option.value = report.id;
                        const quyStr = report.quy === 0 ? "Cả năm" : `Quý ${report.quy}`;
                        option.textContent = `Năm ${report.nam} - ${quyStr}`;
                        baoCaoSelect.appendChild(option);
                    });
                    
                    // Mở khóa dropdown để người dùng chọn
                    baoCaoSelect.disabled = false;
                }
            } catch (error) {
                console.error('Lỗi:', error);
                baoCaoSelect.innerHTML = '<option value="" selected disabled>Lỗi tải báo cáo</option>';
            }
        });

        // --- 3. SUBMIT FORM (Giữ nguyên logic của bạn) ---
        kqkdForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            resultDiv.innerHTML = '<div class="alert alert-info">Đang gửi dữ liệu...</div>';

            const inputs = kqkdForm.querySelectorAll('input[type="number"]');
            const formData = {};

            if (!baoCaoSelect.value || baoCaoSelect.disabled) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Vui lòng chọn Công ty và Báo cáo tài chính!</div>`;
                return;
            }
            formData['baoCao'] = parseInt(baoCaoSelect.value, 10);
            
            for (let input of inputs) {
                if (input.id && input.value !== '') {
                    formData[input.id] = parseInt(input.value, 10);
                }
            }

            try {
                const response = await fetch('/api/post_bangketquakinhdoanh_data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                const alertClass = response.ok ? 'alert-success' : 'alert-danger';
                resultDiv.innerHTML = `<div class="alert ${alertClass}">${data.message || 'Dữ liệu đã được lưu thành công!'}</div>`;

            } catch (error) {
                console.error('Lỗi khi gửi form:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">Lỗi kết nối. Không thể gửi dữ liệu.</div>`;
            }
        });
    });
</script>
{% endblock %}