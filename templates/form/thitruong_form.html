{% extends 'main.html' %}
{% block content %}
<div class="container mt-4">
  <h2>üìà Nh·∫≠p d·ªØ li·ªáu Th·ªã tr∆∞·ªùng ch·ª©ng kho√°n</h2>

  <form id="thiTruongForm">
    <div class="mb-3">
      <label for="congTy" class="form-label">C√¥ng ty</label>
      <select class="form-select" id="congTy" name="congTy" required>
        <option value="">-- Ch·ªçn c√¥ng ty --</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="ngay" class="form-label">Ng√†y giao d·ªãch</label>
      <input type="date" class="form-control" id="ngay" name="ngay" required>
    </div>

    <div class="mb-3">
      <label for="giaDongCua" class="form-label">Gi√° ƒë√≥ng c·ª≠a (ngh√¨n VNƒê)</label>
      <input type="number" step="0.01" class="form-control" id="giaDongCua" required>
    </div>

    <div class="mb-3">
      <label for="giaDieuChinh" class="form-label">Gi√° ƒëi·ªÅu ch·ªânh (ngh√¨n VNƒê)</label>
      <input type="number" step="0.01" class="form-control" id="giaDieuChinh" required>
    </div>

    <div class="mb-3">
      <label for="thayDoi" class="form-label">Thay ƒë·ªïi gi√° (+/-)</label>
      <input type="number" step="0.01" class="form-control" id="thayDoi" required>
    </div>

    <div class="mb-3">
      <label for="klKhopLenh" class="form-label">KL kh·ªõp l·ªánh</label>
      <input type="number" class="form-control" id="klKhopLenh" required>
    </div>

    <div class="mb-3">
      <label for="gtKhopLenh" class="form-label">GT kh·ªõp l·ªánh (t·ª∑ VNƒê)</label>
      <input type="number" step="0.01" class="form-control" id="gtKhopLenh" required>
    </div>

    <div class="mb-3">
      <label for="klThoaThuan" class="form-label">KL th·ªèa thu·∫≠n</label>
      <input type="number" class="form-control" id="klThoaThuan">
    </div>

    <div class="mb-3">
      <label for="gtThoaThuan" class="form-label">GT th·ªèa thu·∫≠n (t·ª∑ VNƒê)</label>
      <input type="number" step="0.01" class="form-control" id="gtThoaThuan">
    </div>

    <div class="mb-3">
      <label for="giaMoCua" class="form-label">Gi√° m·ªü c·ª≠a (ngh√¨n VNƒê)</label>
      <input type="number" step="0.01" class="form-control" id="giaMoCua" required>
    </div>

    <div class="mb-3">
      <label for="giaCaoNhat" class="form-label">Gi√° cao nh·∫•t (ngh√¨n VNƒê)</label>
      <input type="number" step="0.01" class="form-control" id="giaCaoNhat" required>
    </div>

    <div class="mb-3">
      <label for="giaThapNhat" class="form-label">Gi√° th·∫•p nh·∫•t (ngh√¨n VNƒê)</label>
      <input type="number" step="0.01" class="form-control" id="giaThapNhat" required>
    </div>

    <button type="submit" class="btn btn-success">G·ª≠i d·ªØ li·ªáu</button>
  </form>

  <div id="result" class="mt-3"></div>
</div>

<script>
  // üß≠ Load danh s√°ch c√¥ng ty khi trang m·ªü
  async function loadCongTy() {
    const res = await fetch("/api/get_congty_data/");
    const companies = await res.json();
    const select = document.getElementById("congTy");

    companies.forEach(c => {
      const option = document.createElement("option");
      option.value = c.maChungKhoan;  // v√¨ ForeignKey to_field='maChungKhoan'
      option.textContent = `${c.tenCongTy} (${c.maChungKhoan})`;
      select.appendChild(option);
    });
  }

  loadCongTy();

  // üì® Submit form
  document.getElementById("thiTruongForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = {
      congTy: document.getElementById("congTy").value,
      ngay: document.getElementById("ngay").value,
      giaDongCua: document.getElementById("giaDongCua").value,
      giaDieuChinh: document.getElementById("giaDieuChinh").value,
      thayDoi: document.getElementById("thayDoi").value,
      klKhopLenh: document.getElementById("klKhopLenh").value,
      gtKhopLenh: document.getElementById("gtKhopLenh").value,
      klThoaThuan: document.getElementById("klThoaThuan").value || null,
      gtThoaThuan: document.getElementById("gtThoaThuan").value || null,
      giaMoCua: document.getElementById("giaMoCua").value,
      giaCaoNhat: document.getElementById("giaCaoNhat").value,
      giaThapNhat: document.getElementById("giaThapNhat").value,
    };

    const response = await fetch("/api/post_thitruong_data/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify(formData),
    });

    const data = await response.json();
    document.getElementById("result").innerHTML =
      `<div class="alert alert-${response.ok ? 'success' : 'danger'}">${data.message}</div>`;
  });

  // üõ°Ô∏è H√†m l·∫•y CSRF token

</script>
{% endblock %}
