{% extends 'main.html' %}
{% block content %}
<div class="container mt-4">
  <h3>üìä Import B√°o C√°o T√†i Ch√≠nh</h3>

  <form id="importForm">
    <div class="mb-3">
      <label for="congTy" class="form-label">Ch·ªçn C√¥ng Ty</label>
      <select id="congTy" name="congTy" class="form-select" required>
        <option value="">-- Ch·ªçn c√¥ng ty --</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="nam" class="form-label">NƒÉm</label>
      <input type="number" id="nam" name="nam" class="form-control" min="2000" max="2100" required>
    </div>

    <div class="mb-3">
      <label for="quy" class="form-label">Qu√Ω (1-4 ho·∫∑c 0 cho nƒÉm)</label>
      <input type="number" id="quy" name="quy" class="form-control" min="0" max="5" required>
    </div>

    <button type="submit" class="btn btn-primary">Import d·ªØ li·ªáu</button>
  </form>

  <div id="result" class="mt-3"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // üß≠ Load danh s√°ch c√¥ng ty khi trang m·ªü
  async function loadCongTy() {
    const res = await fetch("/api/get_congty_data/");
    const companies = await res.json();
    const select = document.getElementById("congTy");

    companies.forEach(c => {
      const option = document.createElement("option");
      option.value = c.maChungKhoan;  // v√¨ ForeignKey to_field='maChungKhoan'
      option.textContent = `${c.tenCongTy} (${c.maChungKhoan})`;
      select.appendChild(option);
    });
  }

  loadCongTy();


    document.getElementById("importForm").addEventListener("submit", async (e) => { // <-- Th√™m "async" ·ªü ƒë√¢y
        e.preventDefault();

        const formData = {
        congTy: document.getElementById("congTy").value,
        nam: document.getElementById("nam").value,
        quy: document.getElementById("quy").value
        };

        // B√¢y gi·ªù b·∫°n c√≥ th·ªÉ d√πng await b√™n trong h√†m n√†y
        try {
            const response = await fetch("/api/post_tonghoptaichinh_data/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                // ƒê·∫£m b·∫£o b·∫°n c√≥ h√†m getCookie("csrftoken")
                "X-CSRFToken": getCookie("csrftoken") 
            },
            body: JSON.stringify(formData)
            });

            const data = await response.json();
            document.getElementById("result").innerHTML =
            `<div class="alert alert-${response.ok ? 'success' : 'danger'}">${data.message || data.error}</div>`;

        } catch (error) {
            console.error('Fetch error:', error);
            document.getElementById("result").innerHTML =
            `<div class="alert alert-danger">ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.</div>`;
        }
    });
});

</script>
{% endblock %}
