{% extends 'main.html' %}

{% block content %}
<div class="container mt-4 mb-5">
    <h2>Import D·ªØ li·ªáu Th·ªã tr∆∞·ªùng (X·ª≠ l√Ω b·∫±ng JavaScript)</h2>
    <p>File CSV s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát tr∆∞·ªõc khi g·ª≠i l√™n server.</p>

    <div class="mb-3">
        <label for="csvFile" class="form-label">Ch·ªçn file th·ªã tr∆∞·ªùng:</label>
        <input class="form-control" type="file" id="csvFileMarket" accept=".csv">
    </div>
    <div class="mb-3">
        <label for="csvFile" class="form-label">Ch·ªçn file b·∫£ng c√¢n ƒë·ªëi k·∫ø to√°n:</label>
        <input class="form-control" type="file" id="csvFileBalance" accept=".csv">
    </div> 
    <div class="mb-3">
        <label for="csvFile" class="form-label">Ch·ªçn file b·∫£ng k·∫øt qu·∫£ kinh doanh:</label>
        <input class="form-control" type="file" id="csvFileProfit" accept=".csv">
    </div> 
    <div class="mb-3 p-3 border rounded bg-light">
        <label for="jsonFileNews" class="form-label fw-bold">4. Ch·ªçn file Tin T·ª©c (JSON):</label>
        <input class="form-control" type="file" id="jsonFileNews" accept=".json">
        <small class="text-muted">ƒê·ªãnh d·∫°ng file: JSON Array ch·ª©a c√°c object tin t·ª©c.</small>
    </div>    
    <button id="processBtn" class="btn btn-primary">X·ª≠ l√Ω v√† G·ª≠i D·ªØ li·ªáu ‚öôÔ∏è</button>

    <hr>

    <div id="result" class="mt-3"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    
    document.getElementById('processBtn').addEventListener('click', async () => {
        const fileInputMarket = document.getElementById('csvFileMarket');
        const fileInputBalance = document.getElementById('csvFileBalance');
        const fileInputProfit = document.getElementById('csvFileProfit');
        const fileInputNews = document.getElementById('jsonFileNews');
        const resultDiv = document.getElementById('result');

        if (fileInputMarket.files.length === 0 && 
            fileInputBalance.files.length === 0 && 
            fileInputProfit.files.length === 0 &&
            fileInputNews.files.length === 0) {
            resultDiv.innerHTML = `<div class="alert alert-warning">Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file.</div>`;
            return;
        }


        // X·ª≠ l√Ω file Th·ªã tr∆∞·ªùng
        const filemarket = fileInputMarket.files[0];
        // resultDiv.innerHTML = `<div class="alert alert-info">ƒêang ƒë·ªçc v√† x·ª≠ l√Ω file Th·ªã tr∆∞·ªùng...</div>`;
        // x·ª≠ l√≠ file b·∫£ng c√¢n ƒë·ªëi k·∫ø to√°n
        const filebalance = fileInputBalance.files[0];
        // resultDiv.innerHTML += `<div class="alert alert-info">ƒêang ƒë·ªçc v√† x·ª≠ l√Ω file B·∫£ng CƒêKT...</div>`;
        // x·ª≠ l√≠ file b·∫£ng k·∫øt qu·∫£ kinh doanh
        const fileprofit = fileInputProfit.files[0];
        // resultDiv.innerHTML += `<div class="alert alert-info">ƒêang ƒë·ªçc v√† x·ª≠ l√Ω file B·∫£ng KQKD...</div>`;
       
        //============================================= Streaming x·ª≠ l√Ω t·∫£i file l·ªõn (b·∫£ng c√¢n ƒë·ªëi k·∫ø to√°n)===============================================================
        
        let batch = [];
        const BATCH_SIZE = 750; // X·ª≠ l√Ω v√† g·ª≠i 700 d√≤ng/l·∫ßn. B·∫°n c√≥ th·ªÉ tƒÉng/gi·∫£m s·ªë n√†y.
        let rowCounter = 0;
        
        // H√†m helper ƒë·ªÉ g·ª≠i 1 l√¥ d·ªØ li·ªáu l√™n server
        
        async function sendBatch(dataToSend) {
            if (dataToSend.length === 0) return;

            // 1. Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu th√†nh chu·ªói JSON
            const jsonString = JSON.stringify(dataToSend);

            // 2. T√≠nh to√°n k√≠ch th∆∞·ªõc
            // T·∫°o m·ªôt Blob ƒë·ªÉ l·∫•y k√≠ch th∆∞·ªõc byte ch√≠nh x√°c
            const blob = new Blob([jsonString]);
            const sizeInBytes = blob.size;
            const sizeInMB = (sizeInBytes / 1024 / 1024).toFixed(2); // toFixed(2) ƒë·ªÉ l√†m tr√≤n 2 ch·ªØ s·ªë

            // 3. Log k√≠ch th∆∞·ªõc ra console
            console.log(`ƒêang g·ª≠i ${dataToSend.length} d√≤ng, K√≠ch th∆∞·ªõc Payload: ${sizeInMB} MB`);

            // Ki·ªÉm tra nhanh tr∆∞·ªõc khi g·ª≠i
            if (sizeInBytes > 2500000) { // H∆°i th·∫•p h∆°n 2.5MB ƒë·ªÉ an to√†n
                console.warn(`Payload (${sizeInMB} MB) C√ì TH·ªÇ v∆∞·ª£t qu√° gi·ªõi h·∫°n 2.5MB c·ªßa server!`);
            }
            
            resultDiv.innerHTML = `<div class="alert alert-info">ƒê√£ x·ª≠ l√Ω ${rowCounter} d√≤ng. ƒêang g·ª≠i l√¥ ${dataToSend.length} d√≤ng (${sizeInMB} MB)...</div>`;
            
            try {
                const response = await fetch('/api/post_bangcandoiketoan_data/', { // URL c·ªßa b·∫°n
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': getCookie('csrftoken') 
                    },
                    body: jsonString // G·ª≠i chu·ªói JSON ƒë√£ t·∫°o
                });
                
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(`L·ªói server: ${data.message || 'Kh√¥ng r√µ l·ªói'}`);
                }
                console.log(`G·ª≠i batch ${dataToSend.length} d√≤ng th√†nh c√¥ng.`);
                
            } catch (error) {
                console.error('L·ªói khi g·ª≠i batch:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">L·ªói khi g·ª≠i batch: ${error.message}. D·ª´ng x·ª≠ l√Ω.</div>`;
                throw error;
            }
        }   

        async function sendBatchMarket(dataToSend, label = "Th·ªã tr∆∞·ªùng") {
            if (dataToSend.length === 0) return;

            // 1. Chuy·ªÉn sang JSON v√† t√≠nh k√≠ch th∆∞·ªõc
            const jsonString = JSON.stringify(dataToSend);
            const blob = new Blob([jsonString]);
            const sizeInMB = blob.size / 1024 / 1024;
            const MAX_SIZE_MB = 2.5; // Gi·ªõi h·∫°n c·ª©ng

            // 2. KI·ªÇM TRA: N·∫øu l·ªõn h∆°n 2.5MB -> Chia ƒë√¥i v√† g·ªçi ƒë·ªá quy
            if (sizeInMB > MAX_SIZE_MB) {
                console.warn(`‚ö†Ô∏è L√¥ ${label} n·∫∑ng ${sizeInMB.toFixed(2)} MB (> 2.5MB). ƒêang t·ª± ƒë·ªông chia nh·ªè...`);
                
                const mid = Math.floor(dataToSend.length / 2);
                if (mid === 0) return; // Tr∆∞·ªùng h·ª£p 1 d√≤ng qu√° l·ªõn (hi·∫øm g·∫∑p)

                const firstHalf = dataToSend.slice(0, mid);
                const secondHalf = dataToSend.slice(mid);

                // G·ªçi ƒë·ªá quy cho 2 n·ª≠a
                await sendBatchMarket(firstHalf, `${label} (Ph·∫ßn A)`);
                await sendBatchMarket(secondHalf, `${label} (Ph·∫ßn B)`);
                return; 
            }

            // 3. N·∫øu k√≠ch th∆∞·ªõc OK -> G·ª≠i
            resultDiv.innerHTML += `<div class="text-primary mb-1">‚è≥ ƒêang g·ª≠i l√¥ ${label}: ${dataToSend.length} d√≤ng (${sizeInMB.toFixed(2)} MB)...</div>`;
            resultDiv.scrollTop = resultDiv.scrollHeight; // T·ª± cu·ªôn

            try {
                const response = await fetch('/api/post_thitruong_data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: jsonString
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'L·ªói server');

                resultDiv.innerHTML += `<div class="text-success mb-1">‚úÖ G·ª≠i l√¥ ${label} th√†nh c√¥ng!</div>`;
                resultDiv.scrollTop = resultDiv.scrollHeight;

            } catch (error) {
                console.error('L·ªói g·ª≠i batch:', error);
                resultDiv.innerHTML += `<div class="text-danger mb-1">‚ùå L·ªói g·ª≠i ${label}: ${error.message}</div>`;
                throw error; // N√©m l·ªói ƒë·ªÉ d·ª´ng parser n·∫øu c·∫ßn
            }
        }
        //============================================= X·ª≠ l√Ω file Tin T·ª©c===============================================================
        // H√†m ti·ªán √≠ch: Log k·∫øt qu·∫£ ra m√†n h√¨nh
        function logResult(msg, type = 'info') {
            const resultDiv = document.getElementById('result');
            const color = type === 'error' ? 'text-danger' : (type === 'success' ? 'text-success' : 'text-primary');
            resultDiv.innerHTML += `<div class="${color} mb-1">${msg}</div>`;
            resultDiv.scrollTop = resultDiv.scrollHeight; // T·ª± cu·ªôn xu·ªëng d∆∞·ªõi
        }
        async function sendBatchNews(dataToSend, url, dataName) {
            if (dataToSend.length === 0) return;

            // 1. Chuy·ªÉn sang chu·ªói ƒë·ªÉ t√≠nh k√≠ch th∆∞·ªõc
            const jsonString = JSON.stringify(dataToSend);
            const blob = new Blob([jsonString]);
            const sizeInBytes = blob.size;
            const sizeInMB = sizeInBytes / 1024 / 1024;
            const MAX_SIZE_MB = 2.5; // Gi·ªõi h·∫°n c·ª©ng 2.5MB

            // 2. KI·ªÇM TRA: N·∫øu l·ªõn h∆°n 2.5MB -> Chia ƒë√¥i v√† g·ªçi l·∫°i h√†m (ƒê·ªá quy)
            if (sizeInMB > MAX_SIZE_MB) {
                logResult(`‚ö†Ô∏è L√¥ ${dataName} n·∫∑ng ${sizeInMB.toFixed(2)} MB (> 2.5MB). ƒêang t·ª± ƒë·ªông chia nh·ªè...`, 'warning');
                
                const mid = Math.floor(dataToSend.length / 2);
                
                // Tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t: 1 d√≤ng tin t·ª©c duy nh·∫•t m√† n·∫∑ng h∆°n 2.5MB
                if (mid === 0) {
                    logResult(`‚ùå L·ªói: M·ªôt b√†i vi·∫øt ƒë∆°n l·∫ª qu√° l·ªõn (${sizeInMB.toFixed(2)} MB), kh√¥ng th·ªÉ g·ª≠i!`, 'error');
                    return; 
                }

                const firstHalf = dataToSend.slice(0, mid);
                const secondHalf = dataToSend.slice(mid);

                // G·ªçi ƒë·ªá quy cho 2 n·ª≠a
                await sendBatchNews(firstHalf, url, `${dataName} (Ph·∫ßn A)`);
                await sendBatchNews(secondHalf, url, `${dataName} (Ph·∫ßn B)`);
                return; // D·ª´ng h√†m hi·ªán t·∫°i, ƒë·ªÉ c√°c h√†m con x·ª≠ l√Ω
            }

            // 3. N·∫øu k√≠ch th∆∞·ªõc OK (< 2.5MB) -> Ti·∫øn h√†nh g·ª≠i
            logResult(`‚è≥ ƒêang g·ª≠i l√¥ ${dataName}: ${dataToSend.length} d√≤ng (${sizeInMB.toFixed(2)} MB)...`);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': getCookie('csrftoken') 
                    },
                    body: jsonString
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'L·ªói server');
                
                logResult(`‚úÖ G·ª≠i l√¥ ${dataName} th√†nh c√¥ng!`, 'success');
                
            } catch (error) {
                console.error(`L·ªói g·ª≠i ${dataName}:`, error);
                logResult(`‚ùå L·ªói g·ª≠i ${dataName}: ${error.message}`, 'error');
                throw error; 
            }
        }

        if (fileInputNews.files.length > 0) {
            "üü¶ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω file Tin T·ª©c JSON...";
            const file = fileInputNews.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    const fullData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(fullData)) {
                        logResult("‚ùå File JSON ph·∫£i l√† m·ªôt m·∫£ng (Array).", 'error');
                        return;
                    }

                    // Chia nh·ªè m·∫£ng JSON th√†nh c√°c batch
                    for (let i = 0; i < fullData.length; i += BATCH_SIZE) {
                        const batchNews = fullData.slice(i, i + BATCH_SIZE);
                        await sendBatchNews(batchNews, '/api/post_TinTuc_data/', `Tin T·ª©c (${i+1}-${i+batchNews.length})`);
                    }
                    
                    logResult("üèÅ Ho√†n t·∫•t file Tin T·ª©c.", 'success');

                } catch (error) {
                    logResult("‚ùå L·ªói ƒë·ªçc file JSON: " + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }      
        //============================================= X·ª≠ l√Ω file market===============================================================
        if (fileInputMarket.files.length > 0) {
            const filemarket = fileInputMarket.files[0];
            let batchMarket = [];
            const BATCH_SIZE_MARKET = 500; // Gom 500 d√≤ng r·ªìi m·ªõi ki·ªÉm tra size v√† g·ª≠i

            resultDiv.innerHTML = `<div class="alert alert-info">ƒêang ƒë·ªçc v√† x·ª≠ l√Ω file Th·ªã tr∆∞·ªùng (Streaming)...</div>`;

            Papa.parse(filemarket, {
                header: true,
                skipEmptyLines: true,
                step: async function(results, parser) {
                    const row = results.data;

                    // --- Logic chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu (Mapping) ---
                    const cleanValue = (val) => val ? val.toString().trim().replace(/,/g, '') : '';
                    const toInt = (val) => val ? parseInt(cleanValue(val), 10) : null;
                    const toFloat = (val) => val ? parseFloat(cleanValue(val)) : null;

                    // --- ƒêO·∫†N CODE X·ª¨ L√ù NG√ÄY M·ªöI (CH·∫∂T CH·∫º H∆†N) ---
                    let formattedDate = null;
                    if (row.Ng√†y && typeof row.Ng√†y === 'string') {
                        // X√≥a kho·∫£ng tr·∫Øng th·ª´a
                        const dateStr = row.Ng√†y.trim();
                        const parts = dateStr.split('/');
                        
                        // Ki·ªÉm tra ƒë·ªß 3 ph·∫ßn: Ng√†y, Th√°ng, NƒÉm
                        if (parts.length === 3) {
                            let day = parts[0].trim();
                            let month = parts[1].trim();
                            let year = parts[2].trim();

                            // Ki·ªÉm tra n·∫øu thi·∫øu d·ªØ li·ªáu (r·ªóng)
                            if (day === "" || month === "" || year === "") {
                                console.log('d√≤ng th·ª©', row.Ng√†y,row['Gi√° (ngh√¨n VNƒê)_ƒê√≥ng c·ª≠a']);
                                console.warn(`‚ö†Ô∏è D√≤ng l·ªói ƒë·ªãnh d·∫°ng ng√†y (b·ªè qua): ${row.Ng√†y} - M√£: ${row.Ma}`);
                            } else {
                                // T·ª± ƒë·ªông th√™m s·ªë 0 n·∫øu thi·∫øu (v√≠ d·ª•: 1 -> 01)
                                day = day.padStart(2, '0');
                                month = month.padStart(2, '0');
                                
                                // T·∫°o format chu·∫©n YYYY-MM-DD
                                formattedDate = `${year}-${month}-${day}`;
                            }
                        }
                    }
                    // ------------------------------------------------

                    const processedRow = {
                        ngay: formattedDate,
                        congTy: row.Ma ? row.Ma.trim().toUpperCase() : null,
                        giaDongCua: toFloat(row['Gi√° (ngh√¨n VNƒê)_ƒê√≥ng c·ª≠a']),
                        giaDieuChinh: toFloat(row['Gi√° (ngh√¨n VNƒê)_ƒêi·ªÅu ch·ªânh']),
                        thayDoi: toFloat(row['Thay ƒë·ªïi']),
                        klKhopLenh: toInt(row['GD kh·ªõp l·ªánh_Kh·ªëi l∆∞·ª£ng']),
                        gtKhopLenh: toFloat(row['GD kh·ªõp l·ªánh_Gi√° tr·ªã (t·ª∑ VNƒê)']),
                        klThoaThuan: toInt(row['GD th·ªèa thu·∫≠n_Kh·ªëi l∆∞·ª£ng']),
                        gtThoaThuan: toFloat(row['GD th·ªèa thu·∫≠n_Gi√° tr·ªã (t·ª∑ VNƒê)']),
                        giaMoCua: toFloat(row['Gi√° (ngh√¨n VNƒê)_M·ªü c·ª≠a']),
                        giaCaoNhat: toFloat(row['Gi√° (ngh√¨n VNƒê)_Cao nh·∫•t']),
                        giaThapNhat: toFloat(row['Gi√° (ngh√¨n VNƒê)_Th·∫•p nh·∫•t']),
                    };

                    // Ch·ªâ th√™m n·∫øu d√≤ng h·ª£p l·ªá
                    if (processedRow.congTy && processedRow.ngay) {
                        batchMarket.push(processedRow);
                    }

                    // --- Ki·ªÉm tra xem ƒë√£ ƒë·ªß l√¥ ch∆∞a ---
                    if (batchMarket.length >= BATCH_SIZE_MARKET) {
                        parser.pause(); // T·∫°m d·ª´ng ƒë·ªçc file
                        try {
                            // G·ªçi h√†m g·ª≠i (H√†m n√†y s·∫Ω t·ª± chia nh·ªè n·∫øu > 2.5MB)
                            await sendBatchMarket([...batchMarket], `Th·ªã tr∆∞·ªùng`);
                            batchMarket = []; // X√≥a l√¥ c≈© sau khi g·ª≠i xong
                            parser.resume();  // Ti·∫øp t·ª•c ƒë·ªçc
                        } catch (e) {
                            console.error("D·ª´ng x·ª≠ l√Ω do l·ªói g·ª≠i.");
                            parser.abort(); // D·ª´ng h·∫≥n n·∫øu l·ªói m·∫°ng
                        }
                    }
                },
                complete: async function() {
                    // G·ª≠i n·ªët nh·ªØng d√≤ng c√≤n l·∫°i trong l√¥ cu·ªëi c√πng
                    if (batchMarket.length > 0) {
                        await sendBatchMarket(batchMarket, `Th·ªã tr∆∞·ªùng (Cu·ªëi)`);
                    }
                    resultDiv.innerHTML += `<div class="alert alert-success mt-2">üèÅ Ho√†n t·∫•t x·ª≠ l√Ω file Th·ªã tr∆∞·ªùng!</div>`;
                },
                error: function(error) {
                    console.error("L·ªói khi parse CSV:", error);
                    resultDiv.innerHTML += `<div class="alert alert-danger">L·ªói ƒë·ªçc file CSV: ${error.message}</div>`;
                }
            });
        }



        //=============================================== X·ª≠ l√Ω file B·∫£ng CƒêKT===============================================================
        const startLine = 0;
        let currentLine = 0;       
        
        if (fileInputBalance.files.length > 0) { 
        Papa.parse(filebalance, {
            header: true,
            skipEmptyLines: true,
            Worker: true,
            transformHeader: function(header) {
                
                const h = header.trim();
                // --- B·∫¢N ƒê·ªí √ÅNH X·∫† ƒê·∫¶Y ƒê·ª¶ ---
                const headerMap = {
                    // ƒê·ªãnh danh
                    'ma': 'ma', 
                    'years': 'years',
                    'Qu√Ω': 'quy',

                    // T√†i s·∫£n ng·∫Øn h·∫°n
                    'A T√ÄI S·∫¢N NG·∫ÆN H·∫†N': 'taiSanNganHan',
                    'Ti·ªÅn v√† c√°c kho·∫£n t∆∞∆°ng ƒë∆∞∆°ng ti·ªÅn': 'tienVaCacKhoanTuongDuongTien',
                    'Ti·ªÅn': 'tien',
                    'C√°c kho·∫£n t∆∞∆°ng ƒë∆∞∆°ng ti·ªÅn': 'cacKhoanTuongDuongTien',
                    'C√°c kho·∫£n ƒë·∫ßu t∆∞ t√†i ch√≠nh ng·∫Øn h·∫°n': 'cacKhoanDauTuTaiChinhNganHan',
                    'Ch·ª©ng kho√°n kinh doanh': 'chungKhoanKinhDoanh',
                    'D·ª± ph√≤ng gi·∫£m gi√° ch·ª©ng kho√°n kinh doanh': 'duPhongGiamGiaChungKhoanKinhDoanh',
                    'ƒê·∫ßu t∆∞ n·∫Øm gi·ªØ ƒë·∫øn ng√†y ƒë√°o h·∫°n': 'dauTuNamGiuDenNgayDaoHanNH',
                    'C√°c kho·∫£n ph·∫£i thu ng·∫Øn h·∫°n': 'cacKhoanPhaiThuNganHan',
                    'Ph·∫£i thu ng·∫Øn h·∫°n c·ªßa kh√°ch h√†ng': 'phaiThuNganHanCuaKhachHang',
                    'Tr·∫£ tr∆∞·ªõc cho ng∆∞·ªùi b√°n ng·∫Øn h·∫°n': 'traTruocChoNguoiBanNganHan',
                    'Ph·∫£i thu n·ªôi b·ªô ng·∫Øn h·∫°n': 'phaiThuNoiBoNganHan',
                    'Ph·∫£i thu theo ti·∫øn ƒë·ªô k·∫ø ho·∫°ch h·ª£p ƒë·ªìng x√¢y d·ª±ng': 'phaiThuTheoTienDoKeHoachHopDongXayDung',
                    'Ph·∫£i thu v·ªÅ cho vay ng·∫Øn h·∫°n': 'phaiThuVeChoVayNganHan',
                    'Ph·∫£i thu ng·∫Øn h·∫°n kh√°c': 'phaiThuNganHanKhac',
                    'D·ª± ph√≤ng ph·∫£i thu ng·∫Øn h·∫°n kh√≥ ƒë√≤i': 'duPhongPhaiThuNganHanKhoDoi',
                    'T√†i s·∫£n Thi·∫øu ch·ªù x·ª≠ l√Ω': 'taiSanThieuChoXuLy',
                    'H√†ng t·ªìn kho': 'hangTonKho',
                    'D·ª± ph√≤ng gi·∫£m gi√° h√†ng t·ªìn kho': 'duPhongGiamGiaHangTonKho',
                    'T√†i s·∫£n ng·∫Øn h·∫°n kh√°c': 'taiSanNganHanKhac',
                    'Chi ph√≠ tr·∫£ tr∆∞·ªõc ng·∫Øn h·∫°n': 'chiPhiTraTruocNganHan',
                    'Thu·∫ø GTGT ƒë∆∞·ª£c kh·∫•u tr·ª´': 'thueGTGTDuocKhauTru',
                    'Thu·∫ø v√† c√°c kho·∫£n kh√°c ph·∫£i thu Nh√† n∆∞·ªõc': 'thueVaCacKhoanKhacPhaiThuNhaNuoc',
                    'Giao d·ªãch mua b√°n l·∫°i tr√°i phi·∫øu Ch√≠nh ph·ªß': 'giaoDichMuaBanLaiTraiPhieuChinhPhu',

                    // T√†i s·∫£n d√†i h·∫°n
                    'T√ÄI S·∫¢N D√ÄI H·∫†N': 'taiSanDaiHan',
                    'C√°c kho·∫£n ph·∫£i thu d√†i h·∫°n': 'cacKhoanPhaiThuDaiHan',
                    'Ph·∫£i thu d√†i h·∫°n c·ªßa kh√°ch h√†ng': 'phaiThuDaiHanCuaKhachHang',
                    'Tr·∫£ tr∆∞·ªõc cho ng∆∞·ªùi b√°n d√†i h·∫°n': 'traTruocChoNguoiBanDaiHan',
                    'V·ªën kinh doanh ·ªü ƒë∆°n v·ªã tr·ª±c thu·ªôc': 'vonKinhDoanhODonViTrucThuoc',
                    'Ph·∫£i thu n·ªôi b·ªô d√†i h·∫°n': 'phaiThuNoiBoDaiHan',
                    'Ph·∫£i thu v·ªÅ cho vay d√†i h·∫°n': 'phaiThuVeChoVayDaiHan',
                    'Ph·∫£i thu d√†i h·∫°n kh√°c': 'phaiThuDaiHanKhac',
                    'D·ª± ph√≤ng ph·∫£i thu d√†i h·∫°n kh√≥ ƒë√≤i': 'duPhongPhaiThuDaiHanKhoDoi',
                    'T√†i s·∫£n c·ªë ƒë·ªãnh': 'taiSanCoDinh',
                    'T√†i s·∫£n c·ªë ƒë·ªãnh h·ªØu h√¨nh': 'taiSanCoDinhHuuHinh',
                    'Nguy√™n gi√°': 'nguyenGia',
                    'Gi√° tr·ªã hao m√≤n l≈©y k·∫ø': 'giaTriHaoMonLuyKe',
                    'T√†i s·∫£n c·ªë ƒë·ªãnh thu√™ t√†i ch√≠nh': 'taiSanCoDinhThueTaiChinh',
                    'T√†i s·∫£n c·ªë ƒë·ªãnh v√¥ h√¨nh': 'taiSanCoDinhVoHinh',
                    'B·∫•t ƒë·ªông s·∫£n ƒë·∫ßu t∆∞': 'batDongSanDauTu',
                    'T√†i s·∫£n d·ªü dang d√†i h·∫°n': 'taiSanDoDangDaiHan',
                    'Chi ph√≠ s·∫£n xu·∫•t kinh doanh d·ªü dang d√†i h·∫°n': 'chiPhiSanXuatKinhDoanhDoDangDaiHan',
                    'Chi ph√≠ x√¢y d·ª±ng c∆° b·∫£n d·ªü dang': 'chiPhiXayDungCoBanDoDang',
                    'ƒê·∫ßu t∆∞ t√†i ch√≠nh d√†i h·∫°n': 'dauTuTaiChinhDaiHan',
                    'ƒê·∫ßu t∆∞ v√†o c√¥ng ty con': 'dauTuVaoCongTyCon',
                    'ƒê·∫ßu t∆∞ v√†o c√¥ng ty li√™n k·∫øt li√™n doanh': 'dauTuVaoCongTyLienKetLienDoanh',
                    'ƒê·∫ßu t∆∞ g√≥p v·ªën v√†o ƒë∆°n v·ªã kh√°c': 'dauTuGopVonVaoDonViKhac',
                    'D·ª± ph√≤ng ƒë·∫ßu t∆∞ t√†i ch√≠nh d√†i h·∫°n': 'duPhongDauTuTaiChinhDaiHan',
                    'T√†i s·∫£n d√†i h·∫°n kh√°c': 'taiSanDaiHanKhac',
                    'Chi ph√≠ tr·∫£ tr∆∞·ªõc d√†i h·∫°n': 'chiPhiTraTruocDaiHan',
                    'T√†i s·∫£n thu·∫ø thu nh·∫≠p ho√£n l·∫°i': 'taiSanThueThuNhapHoanLai',
                    'Thi·∫øt b·ªã v·∫≠t t∆∞ ph·ª• t√πng thay th·∫ø d√†i h·∫°n': 'thietBiVatTuPhuTungThayTheDaiHan',
                    'L·ª£i th·∫ø th∆∞∆°ng m·∫°i': 'loiTheThuongMai',
                    'T·ªîNG C·ªòNG T√ÄI S·∫¢N': 'tongCongTaiSan',

                    // N·ª£ ph·∫£i tr·∫£
                    'N·ª¢ PH·∫¢I TR·∫¢': 'noPhaiTra',
                    'N·ª£ ng·∫Øn h·∫°n': 'noNganHan',
                    'Ph·∫£i tr·∫£ ng∆∞·ªùi b√°n ng·∫Øn h·∫°n': 'phaiTraNguoiBanNganHan',
                    'Ng∆∞·ªùi mua tr·∫£ ti·ªÅn tr∆∞·ªõc ng·∫Øn h·∫°n': 'nguoiMuaTraTienTruocNganHan',
                    'Thu·∫ø v√† c√°c kho·∫£n ph·∫£i n·ªôp nh√† n∆∞·ªõc': 'thueVaCacKhoanPhaiNopNhaNuoc',
                    'Ph·∫£i tr·∫£ ng∆∞·ªùi lao ƒë·ªông': 'phaiTraNguoiLaoDong',
                    'Chi ph√≠ ph·∫£i tr·∫£ ng·∫Øn h·∫°n': 'chiPhiPhaiTraNganHan',
                    'Ph·∫£i tr·∫£ n·ªôi b·ªô ng·∫Øn h·∫°n': 'phaiTraNoiBoNganHan',
                    'Ph·∫£i tr·∫£ theo ti·∫øn ƒë·ªô k·∫ø ho·∫°ch h·ª£p ƒë·ªìng x√¢y d·ª±ng': 'phaiTraTheoTienDoKeHoachHopDongXayDungNH',
                    'Doanh thu ch∆∞a th·ª±c hi·ªán ng·∫Øn h·∫°n': 'doanhThuChuaThucHienNganHan',
                    'Ph·∫£i tr·∫£ ng·∫Øn h·∫°n kh√°c': 'phaiTraNganHanKhac',
                    'Vay v√† n·ª£ thu√™ t√†i ch√≠nh ng·∫Øn h·∫°n': 'vayVaNoThueTaiChinhNganHan',
                    'D·ª± ph√≤ng ph·∫£i tr·∫£ ng·∫Øn h·∫°n': 'duPhongPhaiTraNganHan',
                    'Qu·ªπ khen th∆∞·ªüng ph√∫c l·ª£i': 'quyKhenThuongPhucLoi',
                    'Qu·ªπ b√¨nh ·ªïn gi√°': 'quyBinhOnGia',
                    'N·ª£ d√†i h·∫°n': 'noDaiHan',
                    'Ph·∫£i tr·∫£ ng∆∞·ªùi b√°n d√†i h·∫°n': 'phaiTraNguoiBanDaiHan',
                    'Ng∆∞·ªùi mua tr·∫£ ti·ªÅn tr∆∞·ªõc d√†i h·∫°n': 'nguoiMuaTraTienTruocDaiHan',
                    'Chi ph√≠ ph·∫£i tr·∫£ d√†i h·∫°n': 'chiPhiPhaiTraDaiHan',
                    'Ph·∫£i tr·∫£ n·ªôi b·ªô v·ªÅ v·ªën kinh doanh': 'phaiTraNoiBoVeVonKinhDoanh',
                    'Ph·∫£i tr·∫£ n·ªôi b·ªô d√†i h·∫°n': 'phaiTraNoiBoDaiHan',
                    'Doanh thu ch∆∞a th·ª±c hi·ªán d√†i h·∫°n': 'doanhThuChuaThucHienDaiHan',
                    'Ph·∫£i tr·∫£ d√†i h·∫°n kh√°c': 'phaiTraDaiHanKhac',
                    'Vay v√† n·ª£ thu√™ t√†i ch√≠nh d√†i h·∫°n': 'vayVaNoThueTaiChinhDaiHan',
                    'Tr√°i phi·∫øu chuy·ªÉn ƒë·ªïi': 'traiPhieuChuyenDoi',
                    'C·ªï phi·∫øu ∆∞u ƒë√£i': 'coPhieuUuDai',
                    'Thu·∫ø thu nh·∫≠p ho√£n l·∫°i ph·∫£i tr·∫£': 'thueThuNhapHoanLaiPhaiTra',
                    'D·ª± ph√≤ng ph·∫£i tr·∫£ d√†i h·∫°n': 'duPhongPhaiTraDaiHan',
                    'Qu·ªπ ph√°t tri·ªÉn khoa h·ªçc v√† c√¥ng ngh·ªá': 'quyPhatTrienKhoaHocVaCongNghe',

                    // V·ªën ch·ªß s·ªü h·ªØu
                    'V·ªêN CH·ª¶ S·ªû H·ªÆU': 'vonChuSoHuu',
                    'V·ªën ch·ªß s·ªü h·ªØu': 'vonChuSoHuuCon',
                    'V·ªën g√≥p c·ªßa ch·ªß s·ªü h·ªØu': 'vonGopCuaChuSoHuu',
                    'Th·∫∑ng d∆∞ v·ªën c·ªï ph·∫ßn': 'thangDuVonCoPhan',
                    'Quy·ªÅn ch·ªçn chuy·ªÉn ƒë·ªïi tr√°i phi·∫øu': 'quyenChonChuyenDoiTraiPhieu',
                    'V·ªën kh√°c c·ªßa ch·ªß s·ªü h·ªØu': 'vonKhacCuaChuSoHuu',
                    'C·ªï phi·∫øu qu·ªπ': 'coPhieuQuy',
                    'Ch√™nh l·ªách ƒë√°nh gi√° l·∫°i t√†i s·∫£n': 'chenhLechDanhGiaLaiTaiSan',
                    'Ch√™nh l·ªách t·ª∑ gi√° h·ªëi ƒëo√°i': 'chenhLechTyGiaHoiDoai',
                    'Qu·ªπ ƒë·∫ßu t∆∞ ph√°t tri·ªÉn': 'quyDauTuPhatTrien',
                    'Qu·ªπ h·ªó tr·ª£ s·∫Øp x·∫øp doanh nghi·ªáp': 'quyHoTroSapXepDoanhNghiep',
                    'Qu·ªπ kh√°c thu·ªôc v·ªën ch·ªß s·ªü h·ªØu': 'quyKhacThuocVonChuSoHuu',
                    'L·ª£i nhu·∫≠n sau thu·∫ø ch∆∞a ph√¢n ph·ªëi': 'loiNhuanSauThueChuaPhanPhoi',
                    'Ngu·ªìn v·ªën ƒë·∫ßu t∆∞ XDCB': 'nguonVonDauTuXDCB',
                    'L·ª£i √≠ch c·ªï ƒë√¥ng kh√¥ng ki·ªÉm so√°t': 'loiIchCoDongKhongKiemSoat',
                    'Ngu·ªìn kinh ph√≠ v√† qu·ªπ kh√°c': 'nguonKinhPhiVaQuyKhac',
                    'Ngu·ªìn kinh ph√≠': 'nguonKinhPhi',
                    'Ngu·ªìn kinh ph√≠ ƒë√£ h√¨nh th√†nh TSCƒê': 'nguonKinhPhiDaHinhThanhTSCD',
                    'T·ªîNG C·ªòNG NGU·ªíN V·ªêN': 'tongCongNguonVon'
                };
                return headerMap[h] || h;
            },
            // STEP: H√†m n√†y ƒë∆∞·ª£c g·ªçi cho M·ªñI D√íNG
            step: async function(result, parser) {

                currentLine++;
                // B·ªè qua c√°c d√≤ng ƒë·∫ßu
                if (currentLine < startLine) return;
                

                const row = result.data;
                
                rowCounter++;

                // X·ª≠ l√Ω t·ª´ng d√≤ng
                try {
                    let processedRow = {};
                    for (const key in row) {
                        if (key !== 'ma') {
                            processedRow[key] = row[key] ? parseInt(row[key].toString().trim().replace(/,/g, ''), 10) || 0 : 0;
                        } else {
                            processedRow[key] = row[key] ? row[key].trim().toUpperCase() : null;
                        }
                    }
                    
                    // Th√™m v√†o l√¥ n·∫øu h·ª£p l·ªá
                    if (processedRow.ma && processedRow.years && processedRow.quy !== null) {
                        batch.push(processedRow);
                    }

                    // N·∫øu l√¥ ƒë·ªß l·ªõn, t·∫°m d·ª´ng parse v√† g·ª≠i
                    if (batch.length >= BATCH_SIZE) {
                        parser.pause(); // T·∫°m d·ª´ng ƒë·ªçc file
                        await sendBatch([...batch]); // G·ª≠i l√¥ d·ªØ li·ªáu
                        batch = []; // X√≥a l√¥ c≈©
                        parser.resume(); // Ti·∫øp t·ª•c ƒë·ªçc file
                    }
                } catch (e) {
                    console.error("L·ªói x·ª≠ l√Ω d√≤ng:", e, row);
                    // D·ª´ng n·∫øu c√≥ l·ªói nghi√™m tr·ªçng (nh∆∞ l·ªói g·ª≠i batch)
                    parser.abort();
                }
            },
            // COMPLETE: ƒê∆∞·ª£c g·ªçi khi file ƒë√£ ƒë∆∞·ª£c ƒë·ªçc h·∫øt
            complete: async function() {
                // G·ª≠i n·ªët ph·∫ßn d·ªØ li·ªáu c√≤n l·∫°i trong l√¥ cu·ªëi c√πng
                try {
                    if (batch.length > 0) {
                        await sendBatch([...batch]);
                    }
                    resultDiv.innerHTML = `<div class="alert alert-success">Ho√†n t·∫•t x·ª≠ l√Ω to√†n b·ªô ${rowCounter} d√≤ng!</div>`;
                    console.log("X·ª≠ l√Ω file ho√†n t·∫•t.");
                } catch (e) {
                    // L·ªói ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong sendBatch, ch·ªâ c·∫ßn log
                    console.log("ƒê√£ x·∫£y ra l·ªói khi g·ª≠i l√¥ cu·ªëi c√πng.");
                }
            },
            error: function(error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ ƒë·ªçc file CSV. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.</div>`;
            }
        });
        }
        //=============================================== X·ª≠ l√Ω file B·∫£ng KQKD===============================================================
        if (fileInputProfit.files.length > 0) {
        Papa.parse(fileprofit, {
            header: true,
            skipEmptyLines: true,
            transformHeader: function(header) {
                const h = header.trim();
                const headerMap = {
                    // ƒê·ªãnh danh
                    'ma': 'ma',
                    'years': 'years',
                    'Qu√Ω': 'quy',

                    // C√°c ch·ªâ ti√™u KQKD
                    'Doanh thu b√°n h√†ng v√† cung c·∫•p d·ªãch v·ª•': 'doanhThuBanHangVaCungCapDichVu',
                    'C√°c kho·∫£n gi·∫£m tr·ª´ doanh thu': 'cacKhoanGiamTruDoanhThu',
                    'Doanh thu thu·∫ßn v·ªÅ b√°n h√†ng v√† cung c·∫•p d·ªãch v·ª•': 'doanhThuThuan',
                    'Gi√° v·ªën h√†ng b√°n': 'giaVonHangBan',
                    'L·ª£i nhu·∫≠n g·ªôp v·ªÅ b√°n h√†ng v√† cung c·∫•p d·ªãch v·ª•': 'loiNhuanGop',
                    'Doanh thu ho·∫°t ƒë·ªông t√†i ch√≠nh': 'doanhThuHoatDongTaiChinh',
                    'Chi ph√≠ t√†i ch√≠nh': 'chiPhiTaiChinh',
                    'Trong ƒë√≥ Chi ph√≠ l√£i vay': 'trongDoChiPhiLaiVay',
                    'Ph·∫ßn l√£i l·ªó trong c√¥ng ty li√™n doanh li√™n k·∫øt': 'phanLaiLoTrongCongTyLienDoanhLienKet',
                    'Chi ph√≠ b√°n h√†ng': 'chiPhiBanHang',
                    'Chi ph√≠ qu·∫£n l√Ω doanh nghi·ªáp': 'chiPhiQuanLyDoanhNghiep',
                    'L·ª£i nhu·∫≠n thu·∫ßn t·ª´ ho·∫°t ƒë·ªông kinh doanh': 'loiNhuanThuanTuHoatDongKinhDoanh',
                    'Thu nh·∫≠p kh√°c': 'thuNhapKhac',
                    'Chi ph√≠ kh√°c': 'chiPhiKhac',
                    'L·ª£i nhu·∫≠n kh√°c': 'loiNhuanKhac',
                    'T·ªïng l·ª£i nhu·∫≠n k·∫ø to√°n tr∆∞·ªõc thu·∫ø': 'tongLoiNhuanKeToanTruocThue',
                    'Chi ph√≠ thu·∫ø TNDN hi·ªán h√†nh': 'chiPhiThueTNDNHienHanh',
                    'Chi ph√≠ thu·∫ø TNDN ho√£n l·∫°i': 'chiPhiThueTNDNHoanLai',
                    'L·ª£i nhu·∫≠n sau thu·∫ø thu nh·∫≠p doanh nghi·ªáp': 'loiNhuanSauThueThuNhapDoanhNghiep'
                };
                return headerMap[h] || h;
            },
            complete: async function(results) {
                const toInt = (val) => val ? parseInt(val.toString().trim().replace(/,/g, ''), 10) || 0 : 0;

                const processedData = results.data.map(row => {
                    for (const key in row) {
                        if (key !== 'ma') { // Gi·ªØ nguy√™n 'ma' l√† chu·ªói
                            row[key] = toInt(row[key]);
                        } else {
                             row[key] = row[key] ? row[key].trim().toUpperCase() : null;
                        }
                    }
                    return row;
                }).filter(item => item.ma && item.years && item.quy !== null);

                if (processedData.length === 0) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file B·∫£ng KQKD.</div>`;
                    return;
                }
                
                resultDiv.innerHTML = `<div class="alert alert-info">ƒê√£ x·ª≠ l√Ω ${processedData.length} d√≤ng. ƒêang g·ª≠i l√™n server...</div>`;
                
                try {
                    const response = await fetch('/api/post_bangketquakinhdoanh_data/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify(processedData)
                    });
                    
                    const data = await response.json();
                    const alertClass = response.ok ? 'alert-success' : 'alert-danger';
                    let message = `<div>${data.message}</div>`;
                    if (data.errors && data.errors.length > 0) {
                        message += '<ul>' + data.errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                    }
                    resultDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
                } catch (error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi. Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu.</div>`;
                }
            },
            error: function(error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ ƒë·ªçc file CSV. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.</div>`;
            }
        });
        }
    });
</script>
{% endblock %}