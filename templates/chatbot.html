{% extends "main.html" %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Financial Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- 1. RESET & LAYOUT --- */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            height: 100vh;
            margin: 0;
        }

        /* --- TH√äM CSS ƒê·ªÇ HI·ªÇN TH·ªä FORMAT ƒê·∫∏P H∆†N --- */
        .bot-message p { margin: 5px 0; } /* C√°ch d√≤ng ƒëo·∫°n vƒÉn */
        .bot-message ul, .bot-message ol { margin: 5px 0; padding-left: 20px; } /* Th·ª•t ƒë·∫ßu d√≤ng cho list */
        .bot-message strong { font-weight: bold; color: #000; } /* In ƒë·∫≠m r√µ h∆°n */
        .bot-message pre { 
            background: #2d2d2d; 
            color: #fff; 
            padding: 10px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-family: monospace;
        } /* N·∫øu bot tr·∫£ v·ªÅ code block */


        .typing-indicator {
            background-color: #e9e9eb; /* M√†u n·ªÅn gi·ªëng tin nh·∫Øn bot */
            padding: 15px 20px;
            border-radius: 20px;
            border-bottom-left-radius: 4px; /* Bo g√≥c ƒë·∫∑c tr∆∞ng c·ªßa bot */
            display: table; /* ƒê·ªÉ √¥m v·ª´a n·ªôi dung */
            align-self: flex-start;
            margin-bottom: 15px;
            position: relative;
            width: fit-content;
        }

        /* C√°c d·∫•u ch·∫•m */
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #90949c; /* M√†u ch·∫•m x√°m */
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out both;
            margin: 0 2px; /* Kho·∫£ng c√°ch gi·ªØa c√°c ch·∫•m */
        }

        /* Ch·ªânh ƒë·ªô tr·ªÖ (delay) ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng s√≥ng */
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        /* Animation nh√∫n nh·∫£y */
        @keyframes typing-bounce {
            0%, 80%, 100% { 
                transform: scale(0); 
                opacity: 0.5;
            }
            40% { 
                transform: scale(1); 
                opacity: 1;
            }
        }
        /* --- 2. MAIN CHAT CONTAINER (R·ªòNG H∆†N) --- */
        .chat-container {
            width: 900px; /* TƒÉng t·ª´ 500px l√™n 900px ƒë·ªÉ ch·ª©a b·∫£ng */
            max-width: 95%; /* Responsive tr√™n mobile */
            height: 85vh;   /* Cao 85% m√†n h√¨nh */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Bo g√≥c tr·ªçn v·∫πn */
        }

        /* --- 3. CHAT AREA --- */
        #chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 15px; /* Kho·∫£ng c√°ch gi·ªØa c√°c tin nh·∫Øn */
        }

        /* --- 4. MESSAGE BUBBLES --- */
        .message {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
            max-width: 75%; /* Tin nh·∫Øn th∆∞·ªùng ch·ªâ chi·∫øm 75% */
            word-wrap: break-word;
            position: relative;
        }

        .user-message {
            background-color: #0084ff;
            color: white;
            align-self: flex-end; /* N·∫±m b√™n ph·∫£i */
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            background-color: #e4e6eb;
            color: #050505;
            align-self: flex-start; /* N·∫±m b√™n tr√°i */
            border-bottom-left-radius: 4px;
        }

        /* --- 5. REPORT MESSAGE (STYLE ƒê·∫∂C BI·ªÜT CHO B·∫¢NG) --- */
        /* Khi tin nh·∫Øn l√† b√°o c√°o, n√≥ s·∫Ω r·ªông full m√†n h√¨nh chat */
        .message.report-message {
            max-width: 98%; /* R·ªông g·∫ßn h·∫øt khung */
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }

        /* --- 6. LOADING ANIMATION --- */
        .bot-message.loading {
            padding-right: 30px;
        }
        .bot-message.loading::after {
            content: '...';
            position: absolute;
            animation: typing 1.5s infinite;
            display: inline-block;
            width: 20px;
            text-align: left;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        /* --- 7. INPUT AREA --- */
        #chat-form {
            display: flex;
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }

        #message-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 24px;
            padding: 12px 20px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }
        #message-input:focus {
            border-color: #0084ff;
        }

        #send-button {
            border: none;
            background-color: #0084ff;
            color: white;
            border-radius: 50%; /* N√∫t tr√≤n */
            width: 45px;
            height: 45px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        #send-button:hover {
            background-color: #006bce;
        }

        /* --- 8. TABLE STYLES (QUAN TR·ªåNG) --- */
        .table-wrapper {
            overflow-x: auto; /* Cho ph√©p cu·ªôn ngang n·∫øu b·∫£ng qu√° r·ªông */
            margin-top: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        table.financial-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px; /* Ch·ªØ nh·ªè g·ªçn */
            font-family: 'Segoe UI', sans-serif;
            min-width: 600px; /* ƒê·∫£m b·∫£o b·∫£ng kh√¥ng b·ªã co qu√° nh·ªè */
        }

        table.financial-table th, 
        table.financial-table td {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
        }

        table.financial-table th {
            background-color: #f8f9fa;
            color: #444;
            font-weight: 600;
            text-align: center;
            white-space: nowrap; /* Kh√¥ng xu·ªëng d√≤ng ti√™u ƒë·ªÅ */
        }

        table.financial-table td {
            text-align: right;
            color: #333;
        }

        table.financial-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #0056b3; /* M√†u xanh cho c·ªôt NƒÉm */
            position: sticky; /* C·ªë ƒë·ªãnh c·ªôt ƒë·∫ßu ti√™n (t√πy ch·ªçn) */
            left: 0;
            background-color: #fff;
        }

        table.financial-table caption {
            caption-side: top;
            font-size: 1.1em;
            font-weight: bold;
            color: #0084ff;
            text-align: left;
            margin-bottom: 8px;
            padding-left: 5px;
        }
        
        .company-separator {
            border-top: 2px dashed #ccc;
            margin: 20px 0;
        }

    </style>
</head>
<body>
    <div class="chat-container">
        <div style="padding: 15px; border-bottom: 1px solid #eee; background: #fff; font-weight: bold; color: #333; display: flex; align-items: center;">
            <div style="width: 10px; height: 10px; background: #28a745; border-radius: 50%; margin-right: 10px;"></div>
            Tr·ª£ l√Ω T√†i ch√≠nh AI
        </div>

        <div id="chat-box">
            <div class="message bot-message">Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n? <br> G√µ <strong>/report</strong> ƒë·ªÉ xem b·∫£ng t·ªïng h·ª£p t√†i ch√≠nh chi ti·∫øt.</div>
        </div>

        <form id="chat-form">
            {% csrf_token %} 
            <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
            <button id="send-button" type="submit">‚û§</button>
        </form>
    </div>

    <script>
        console.log("Chatbot page loaded.");
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');

        // H√†m helper l·∫•y cookie (gi·ªØ nguy√™n)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 1. WebSocket
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        const socket = new WebSocket(
            ws_scheme + '://' + window.location.host + '/ws/chat/'
        );
        // --- 4. H√ÄM TH√äM TIN NH·∫ÆN (ƒê√É C·∫¨P NH·∫¨T) ---
        // Th√™m tham s·ªë isWide ƒë·ªÉ ch·ªâ ƒë·ªãnh tin nh·∫Øn n√†o c·∫ßn m·ªü r·ªông (nh∆∞ B√°o c√°o)
        function addMessage(text, sender, isLoading = false, isHtml = false, isWide = false) {
            // 1. X·ª≠ l√Ω Loading
            if (isLoading) {
                const loadingContainer = document.createElement('div');
                loadingContainer.classList.add('typing-indicator');
                loadingContainer.id = 'loading-message';
                loadingContainer.innerHTML = '<span></span><span></span><span></span>';
                chatBox.appendChild(loadingContainer);
                chatBox.scrollTop = chatBox.scrollHeight;
                return loadingContainer;
            }

            // 2. T·∫°o ph·∫ßn t·ª≠ tin nh·∫Øn
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender + '-message');

            if (isHtml) {
                // N·∫øu l√† HTML (Markdown ƒë√£ parse ho·∫∑c B√°o c√°o)
                // Ch·ªâ th√™m class report-message (l√†m r·ªông khung) n·∫øu isWide = true
                if (isWide) {
                    messageElement.classList.add('report-message');
                }
                messageElement.innerHTML = text;
            } else {
                // Tin nh·∫Øn vƒÉn b·∫£n thu·∫ßn (th∆∞·ªùng l√† c·ªßa User)
                messageElement.textContent = text;
            }
            
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            return messageElement;
        }
        // 2. H√†m x√≥a loading
        function removeLoading() {
            // T√¨m t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ class 'typing-indicator'
            const loaders = document.querySelectorAll('.typing-indicator');
            
            // X√≥a t·ª´ng c√°i m·ªôt
            loaders.forEach(loader => {
                loader.remove();
            });
        }
        // 3. H√†m fetch l∆∞u tin nh·∫Øn (gi·ªØ nguy√™n)
        async function saveMessageToServer(sender, content) {
            try {
                await fetch('/api/save-message/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ sender: sender, content: content })
                });
            } catch (error) { console.error(error); }
        }

        // 4. H√†m ƒë·ªãnh d·∫°ng s·ªë
        function formatNumber(value) {
            if (typeof value === 'string') return value;
            return (value * 100).toFixed(2) + '%';
        }

        // 5. H√†m t·∫°o HTML B·∫£ng (C·∫¨P NH·∫¨T C·∫§U TR√öC B·∫¢NG)
        function formatReport(data) {
            let html = '<div style="margin-bottom: 10px;">üìä <strong>B√ÅO C√ÅO T√ÄI CH√çNH T·ªîNG H·ª¢P</strong></div>';
            
            let count = 0;
            for (const companyCode in data) {
                const companyData = data[companyCode];
                if(count > 0) html += '<div class="company-separator"></div>';
                
                // B·∫Øt ƒë·∫ßu wrapper b·∫£ng (ƒë·ªÉ scroll ngang)
                html += `
                    <div class="table-wrapper">
                        <table class="financial-table">
                            <caption>${companyCode} - ${companyData.tenCongTy}</caption>
                            <thead>
                                <tr>
                                    <th>NƒÉm</th>
                                    <th>ROA</th>
                                    <th>ROE</th>
                                    <th>TT T√†i S·∫£n</th>
                                    <th>TT L·ª£i Nhu·∫≠n</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                const years = Object.keys(companyData.annual_reports).sort((a, b) => b - a);
                
                for (const year of years) {
                    const report = companyData.annual_reports[year];
                    
                    if (typeof report === 'string') {
                         html += `<tr><td>${year}</td><td colspan="4" style="text-align:center; color:#999;">${report}</td></tr>`;
                    } else {
                        html += `
                            <tr>
                                <td>${year}</td>
                                <td>${formatNumber(report.ROA)}</td>
                                <td>${formatNumber(report.ROE)}</td>
                                <td>${formatNumber(report.TangTruongTaiSan)}</td>
                                <td style="font-weight:bold; color: ${report.TangTruongLoiNhuan > 0 ? 'green' : 'red'}">
                                    ${formatNumber(report.TangTruongLoiNhuan)}
                                </td>
                            </tr>
                        `;
                    }
                }
                html += '</tbody></table></div>'; // ƒê√≥ng wrapper
                count++;
            }
            return html;
        }

        // 6. Fetch Report Logic
        async function fetchFinancialReport() {
            const loadingMsg = addMessage("ƒêang t·ªïng h·ª£p d·ªØ li·ªáu...", 'bot', true);
            try {
                const response = await fetch('/api/financial-ratios/');
                if (!response.ok) throw new Error('Network err');
                const data = await response.json();
                
                loadingMsg.remove();
                
                // G·ªçi h√†m format m·ªõi
                const formattedHtml = formatReport(data);
                addMessage(formattedHtml, 'bot', false, true); // isHtml = true

            } catch (error) {
                loadingMsg.remove();
                addMessage('L·ªói t·∫£i b√°o c√°o.', 'bot');
            }
        }

        // 7. Event Listener
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            if (message.toLowerCase() === '/report') {
                fetchFinancialReport();
            } else {
                socket.send(JSON.stringify({ 'message': message }));
                saveMessageToServer('user', message);
                
                const loading = addMessage("", 'bot', true);
                loading.classList.add('loading');
            }
        });

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            // X√≥a loading
            
            if (data.type === 'bot_response') {
                // --- S·ª¨A ƒêO·∫†N N√ÄY ---
                // D√πng marked ƒë·ªÉ chuy·ªÉn Markdown c·ªßa Gemini sang HTML
                const htmlContent = marked.parse(data.message);
                
                removeLoading();
                // G·ªçi addMessage v·ªõi isHtml = true, nh∆∞ng isWide = false (ƒë·ªÉ bong b√≥ng chat g·ªçn g√†ng)
                addMessage(htmlContent, 'bot', false, true, false);
                // --------------------
                
                saveMessageToServer('bot', data.message);
            } else if (data.type === 'error') {
                addMessage(`L·ªói: ${data.message}`, 'bot');
            }
        };

    </script>
</body>
{% endblock %}